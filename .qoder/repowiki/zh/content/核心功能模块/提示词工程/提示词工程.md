# 提示词工程

<cite>
**本文档引用的文件**
- [prompt_transform.py](file://api\core\prompt\prompt_transform.py)
- [simple_prompt_transform.py](file://api\core\prompt\simple_prompt_transform.py)
- [advanced_prompt_transform.py](file://api\core\prompt\advanced_prompt_transform.py)
- [advanced_prompt_entities.py](file://api\core\prompt\entities\advanced_prompt_entities.py)
- [prompt_template_parser.py](file://api\core\prompt\utils\prompt_template_parser.py)
- [idea-output.tsx](file://web\app\components\app\configuration\config\automatic\idea-output.tsx)
- [debug-with-multiple-model\index.tsx](file://web\app\components\app\configuration\debug\debug-with-multiple-model\index.tsx)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
Dify的提示词工程系统提供了一套完整的提示词开发环境，支持从简单到复杂的各种提示词设计需求。系统包含Prompt IDE、多模型对比和实时调试三大核心功能，帮助开发者构建高效、可靠的提示词模板。本文档详细解释了这些功能的设计理念和实现方法，并提供了最佳实践指导。

## 项目结构
Dify的提示词工程功能主要分布在API核心模块和Web前端组件中。后端逻辑集中在`api/core/prompt`目录，包含提示词转换、模板解析和上下文管理等核心功能。前端界面位于`web/app/components/app/configuration`目录，提供了直观的用户交互界面。

```mermaid
graph TB
subgraph "后端"
A[prompt_transform.py]
B[simple_prompt_transform.py]
C[advanced_prompt_transform.py]
D[advanced_prompt_entities.py]
E[prompt_template_parser.py]
end
subgraph "前端"
F[idea-output.tsx]
G[debug-with-multiple-model/index.tsx]
end
A --> |基础功能| B
A --> |高级功能| C
D --> |数据结构| C
E --> |模板解析| B
E --> |模板解析| C
F --> |理想输出配置| G
G --> |多模型调试| B
G --> |多模型调试| C
```

**Diagram sources**
- [prompt_transform.py](file://api\core\prompt\prompt_transform.py)
- [simple_prompt_transform.py](file://api\core\prompt\simple_prompt_transform.py)
- [advanced_prompt_transform.py](file://api\core\prompt\advanced_prompt_transform.py)
- [advanced_prompt_entities.py](file://api\core\prompt\entities\advanced_prompt_entities.py)
- [prompt_template_parser.py](file://api\core\prompt\utils\prompt_template_parser.py)
- [idea-output.tsx](file://web\app\components\app\configuration\config\automatic\idea-output.tsx)
- [debug-with-multiple-model\index.tsx](file://web\app\components\app\configuration\debug\debug-with-multiple-model\index.tsx)

**Section sources**
- [prompt_transform.py](file://api\core\prompt\prompt_transform.py)
- [simple_prompt_transform.py](file://api\core\prompt\simple_prompt_transform.py)
- [advanced_prompt_transform.py](file://api\core\prompt\advanced_prompt_transform.py)
- [advanced_prompt_entities.py](file://api\core\prompt\entities\advanced_prompt_entities.py)
- [prompt_template_parser.py](file://api\core\prompt\utils\prompt_template_parser.py)
- [idea-output.tsx](file://web\app\components\app\configuration\config\automatic\idea-output.tsx)
- [debug-with-multiple-model\index.tsx](file://web\app\components\app\configuration\debug\debug-with-multiple-model\index.tsx)

## 核心组件
Dify的提示词工程系统由多个核心组件构成，包括提示词转换器、模板解析器、上下文管理器和多模型调试器。这些组件协同工作，实现了从提示词设计到执行的完整流程。

**Section sources**
- [prompt_transform.py](file://api\core\prompt\prompt_transform.py)
- [simple_prompt_transform.py](file://api\core\prompt\simple_prompt_transform.py)
- [advanced_prompt_transform.py](file://api\core\prompt\advanced_prompt_transform.py)
- [advanced_prompt_entities.py](file://api\core\prompt\entities\advanced_prompt_entities.py)
- [prompt_template_parser.py](file://api\core\prompt\utils\prompt_template_parser.py)

## 架构概述
Dify的提示词工程采用分层架构设计，分为基础提示词转换层和高级提示词转换层。基础层处理简单的提示词模板，高级层支持复杂的条件逻辑和变量插值。系统通过统一的接口对外提供服务，确保了功能的灵活性和可扩展性。

```mermaid
graph TD
A[用户界面] --> B[Prompt IDE]
B --> C[多模型对比]
B --> D[实时调试]
C --> E[基础提示词转换]
D --> F[高级提示词转换]
E --> G[模板解析]
F --> G
G --> H[上下文管理]
H --> I[输出格式控制]
I --> J[最终输出]
```

**Diagram sources**
- [prompt_transform.py](file://api\core\prompt\prompt_transform.py)
- [simple_prompt_transform.py](file://api\core\prompt\simple_prompt_transform.py)
- [advanced_prompt_transform.py](file://api\core\prompt\advanced_prompt_transform.py)
- [prompt_template_parser.py](file://api\core\prompt\utils\prompt_template_parser.py)

## 详细组件分析

### Prompt IDE设计理念
Dify的Prompt IDE设计旨在提供一个直观、高效的提示词开发环境。系统支持变量插值、条件逻辑和上下文管理等高级功能，帮助开发者构建复杂的提示词模板。

#### 变量插值和条件逻辑
```mermaid
classDiagram
class PromptTemplateParser {
+template : str
+variable_keys : list[str]
+extract() list[str]
+format(inputs : dict) str
-regex : Pattern
}
class SimplePromptTransform {
+get_prompt() tuple[list[PromptMessage], Optional[list[str]]]
+_get_prompt_str_and_rules() tuple[str, dict]
+_get_chat_model_prompt_messages() tuple[list[PromptMessage], Optional[list[str]]]
+_get_completion_model_prompt_messages() tuple[list[PromptMessage], Optional[list[str]]]
}
class AdvancedPromptTransform {
+get_prompt() list[PromptMessage]
+_get_completion_model_prompt_messages() list[PromptMessage]
+_get_chat_model_prompt_messages() list[PromptMessage]
+_set_context_variable() dict
+_set_query_variable() dict
+_set_histories_variable() dict
}
PromptTemplateParser --> SimplePromptTransform : "used by"
PromptTemplateParser --> AdvancedPromptTransform : "used by"
SimplePromptTransform --> AdvancedPromptTransform : "extends"
```

**Diagram sources**
- [prompt_template_parser.py](file://api\core\prompt\utils\prompt_template_parser.py)
- [simple_prompt_transform.py](file://api\core\prompt\simple_prompt_transform.py)
- [advanced_prompt_transform.py](file://api\core\prompt\advanced_prompt_transform.py)

### 多模型对比功能
Dify的多模型对比功能允许用户同时测试多个模型的输出，帮助选择最佳模型配置。

#### 多模型调试流程
```mermaid
sequenceDiagram
participant 用户 as "用户"
participant 前端 as "前端界面"
participant 后端 as "后端服务"
用户->>前端 : 配置多个模型
前端->>后端 : 发送多模型请求
后端->>后端 : 并行处理各模型
后端->>后端 : 执行提示词转换
后端->>后端 : 生成各模型输出
后端-->>前端 : 返回多模型结果
前端-->>用户 : 显示对比结果
```

**Diagram sources**
- [debug-with-multiple-model\index.tsx](file://web\app\components\app\configuration\debug\debug-with-multiple-model\index.tsx)
- [simple_prompt_transform.py](file://api\core\prompt\simple_prompt_transform.py)
- [advanced_prompt_transform.py](file://api\core\prompt\advanced_prompt_transform.py)

### 实时调试能力
Dify的实时调试功能提供了即时反馈，帮助开发者快速优化提示词。

#### 调试流程
```mermaid
flowchart TD
Start([开始调试]) --> 配置["配置提示词参数"]
配置 --> 输入["输入测试查询"]
输入 --> 执行["执行提示词转换"]
执行 --> 分析["分析模型输出"]
分析 --> 优化["优化提示词"]
优化 --> 结束([结束调试])
分析 --> 问题{"输出是否符合预期?"}
问题 --> |否| 优化
问题 --> |是| 结束
```

**Diagram sources**
- [debug-with-multiple-model\index.tsx](file://web\app\components\app\configuration\debug\debug-with-multiple-model\index.tsx)
- [simple_prompt_transform.py](file://api\core\prompt\simple_prompt_transform.py)

### 上下文管理和历史对话处理
Dify的上下文管理功能确保了对话的连贯性和一致性。

#### 上下文管理流程
```mermaid
flowchart TD
Start([函数入口]) --> 计算["计算剩余token"]
计算 --> 检查{"是否有历史记录?"}
检查 --> |是| 获取["获取历史消息"]
检查 --> |否| 添加["添加当前消息"]
获取 --> 限制{"是否超过token限制?"}
限制 --> |是| 截断["截断历史消息"]
限制 --> |否| 添加
截断 --> 添加
添加 --> 结束([函数退出])
```

**Diagram sources**
- [prompt_transform.py](file://api\core\prompt\prompt_transform.py)
- [simple_prompt_transform.py](file://api\core\prompt\simple_prompt_transform.py)

### 输出格式控制
Dify提供了灵活的输出格式控制机制，确保输出符合预期格式。

#### 输出格式控制流程
```mermaid
flowchart TD
Start([开始]) --> 检查["检查输出规则"]
检查 --> 应用{"是否有停止词?"}
应用 --> |是| 设置["设置停止词"]
应用 --> |否| 继续["继续处理"]
设置 --> 继续
继续 --> 生成["生成最终输出"]
生成 --> 结束([结束])
```

**Diagram sources**
- [simple_prompt_transform.py](file://api\core\prompt\simple_prompt_transform.py)

## 依赖分析
Dify的提示词工程系统依赖于多个核心模块，包括模型管理、文件管理和内存管理。这些模块协同工作，确保了系统的稳定性和性能。

```mermaid
erDiagram
PROMPT_TEMPLATE {
string text PK
string edition_type
}
MEMORY_CONFIG {
boolean window_enabled
integer window_size
string user_prefix
string assistant_prefix
string query_prompt_template
}
MODEL_CONFIG {
string provider PK
string model PK
string mode
json parameters
}
PROMPT_TEMPLATE ||--o{ MODEL_CONFIG : "适用于"
MEMORY_CONFIG ||--o{ MODEL_CONFIG : "配置"
```

**Diagram sources**
- [advanced_prompt_entities.py](file://api\core\prompt\entities\advanced_prompt_entities.py)
- [simple_prompt_transform.py](file://api\core\prompt\simple_prompt_transform.py)
- [advanced_prompt_transform.py](file://api\core\prompt\advanced_prompt_transform.py)

## 性能考虑
Dify的提示词工程系统在设计时充分考虑了性能因素，通过优化算法和缓存机制确保了高效的执行速度。

## 故障排除指南
当遇到提示词输出不一致或偏离主题等问题时，可以按照以下步骤进行排查：

**Section sources**
- [prompt_transform.py](file://api\core\prompt\prompt_transform.py)
- [simple_prompt_transform.py](file://api\core\prompt\simple_prompt_transform.py)
- [advanced_prompt_transform.py](file://api\core\prompt\advanced_prompt_transform.py)

## 结论
Dify的提示词工程系统提供了一套完整的解决方案，从简单的问答到复杂的指令遵循都能有效支持。通过合理的架构设计和功能实现，系统能够满足各种提示词开发需求。