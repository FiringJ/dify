# 工具集成

<cite>
**本文档引用的文件**
- [tool_engine.py](file://api/core/tools/tool_engine.py)
- [tool_node.py](file://api/core/workflow/nodes/tool/tool_node.py)
- [builtin_tool.py](file://api/core/tools/builtin_tool/tool.py)
- [custom_tool.py](file://api/core/tools/custom_tool/tool.py)
- [mcp_tool.py](file://api/core/tools/mcp_tool/tool.py)
- [tool_manager.py](file://api/core/tools/tool_manager.py)
- [simple_code.py](file://api/core/tools/builtin_tool/providers/code/tools/simple_code.py)
- [code.py](file://api/core/tools/builtin_tool/providers/code/code.py)
</cite>

## 目录
1. [简介](#简介)
2. [工具集成架构](#工具集成架构)
3. [内置工具集成](#内置工具集成)
4. [自定义工具集成](#自定义工具集成)
5. [MCP工具集成](#mcp工具集成)
6. [工具节点配置](#工具节点配置)
7. [输入输出映射](#输入输出映射)
8. [错误处理机制](#错误处理机制)
9. [凭证配置与安全沙箱](#凭证配置与安全沙箱)
10. [调用限制策略](#调用限制策略)
11. [常见问题排查](#常见问题排查)

## 简介
Dify工作流工具集成系统提供了一套完整的工具集成框架，支持内置工具、自定义工具和MCP工具的无缝集成。该系统通过统一的工具引擎和工具管理器，实现了工具的注册、配置、调用和监控。用户可以在工作流中灵活调用各类工具，实现复杂业务逻辑的自动化处理。

## 工具集成架构

```mermaid
graph TD
subgraph "工具管理层"
ToolManager[工具管理器]
ToolLabelManager[工具标签管理器]
ToolParameterConfigurationManager[工具参数配置管理器]
end
subgraph "工具运行时层"
ToolEngine[工具引擎]
ToolRuntime[工具运行时]
end
subgraph "工具提供者层"
BuiltinProvider[内置工具提供者]
CustomProvider[自定义工具提供者]
MCPProvider[MCP工具提供者]
PluginProvider[插件工具提供者]
WorkflowProvider[工作流作为工具提供者]
end
subgraph "工具节点层"
ToolNode[工具节点]
Workflow[工作流]
end
ToolNode --> ToolEngine
ToolEngine --> ToolManager
ToolManager --> BuiltinProvider
ToolManager --> CustomProvider
ToolManager --> MCPProvider
ToolManager --> PluginProvider
ToolManager --> WorkflowProvider
ToolManager --> ToolLabelManager
ToolManager --> ToolParameterConfigurationManager
ToolRuntime --> ToolEngine
style ToolManager fill:#f9f,stroke:#333
style ToolEngine fill:#bbf,stroke:#333
```

**图示来源**
- [tool_manager.py](file://api/core/tools/tool_manager.py)
- [tool_engine.py](file://api/core/tools/tool_engine.py)

**本节来源**
- [tool_manager.py](file://api/core/tools/tool_manager.py#L1-L1022)
- [tool_engine.py](file://api/core/tools/tool_engine.py#L1-L355)

## 内置工具集成

内置工具是Dify平台预置的常用功能工具，包括HTTP请求、代码执行、时间处理和网页抓取等。这些工具通过`BuiltinToolProviderController`进行管理，用户无需额外配置即可直接使用。

### 代码执行工具
代码执行工具支持Python3和JavaScript语言，通过安全沙箱环境执行用户提供的代码。工具使用`CodeExecutor`组件进行代码执行，确保执行过程的安全性。

```mermaid
sequenceDiagram
participant User as "用户"
participant Workflow as "工作流"
participant ToolNode as "工具节点"
participant ToolEngine as "工具引擎"
participant CodeExecutor as "代码执行器"
User->>Workflow : 提交代码执行请求
Workflow->>ToolNode : 创建工具节点
ToolNode->>ToolEngine : 调用工具引擎
ToolEngine->>CodeExecutor : 执行代码
CodeExecutor-->>ToolEngine : 返回执行结果
ToolEngine-->>ToolNode : 返回工具调用结果
ToolNode-->>Workflow : 返回节点执行结果
Workflow-->>User : 返回最终结果
```

**图示来源**
- [simple_code.py](file://api/core/tools/builtin_tool/providers/code/tools/simple_code.py)
- [tool_engine.py](file://api/core/tools/tool_engine.py)

**本节来源**
- [simple_code.py](file://api/core/tools/builtin_tool/providers/code/tools/simple_code.py#L1-L33)
- [code.py](file://api/core/tools/builtin_tool/providers/code/code.py#L1-L8)

### HTTP请求工具
HTTP请求工具允许工作流发起HTTP请求，支持GET、POST、PUT、DELETE等方法。工具通过`ssrf_proxy`组件进行请求代理，防止SSRF攻击。

## 自定义工具集成

自定义工具允许用户集成外部API服务，通过OpenAPI规范定义工具接口。工具配置包括服务器URL、请求方法、参数定义和认证方式。

### 工具配置流程
1. 在Dify控制台创建自定义工具
2. 定义工具的OpenAPI规范
3. 配置认证方式（API Key、OAuth等）
4. 测试工具连接
5. 在工作流中使用工具

### 认证方式
自定义工具支持多种认证方式：
- API Key（Header）
- API Key（Query Parameter）
- OAuth 2.0
- 无认证

```mermaid
flowchart TD
Start([开始]) --> ValidateCredentials["验证凭证"]
ValidateCredentials --> CredentialsValid{"凭证有效?"}
CredentialsValid --> |否| ReturnError["返回错误"]
CredentialsValid --> |是| AssembleRequest["组装请求"]
AssembleRequest --> MakeRequest["发起HTTP请求"]
MakeRequest --> ResponseReceived{"收到响应?"}
ResponseReceived --> |否| HandleTimeout["处理超时"]
ResponseReceived --> |是| ValidateResponse["验证响应"]
ValidateResponse --> ResponseValid{"响应有效?"}
ResponseValid --> |否| HandleError["处理错误"]
ResponseValid --> |是| ParseResponse["解析响应"]
ParseResponse --> ReturnResult["返回结果"]
HandleTimeout --> ReturnError
HandleError --> ReturnError
ReturnResult --> End([结束])
ReturnError --> End
```

**图示来源**
- [custom_tool.py](file://api/core/tools/custom_tool/tool.py)

**本节来源**
- [custom_tool.py](file://api/core/tools/custom_tool/tool.py#L1-L404)

## MCP工具集成

MCP（Model Context Protocol）工具是基于MCP协议的智能工具，通过MCP客户端与工具服务器通信。MCP工具支持流式响应和复杂数据类型（文本、图像、JSON等）。

### MCP工具调用流程
1. 创建MCP客户端连接
2. 验证MCP服务器认证
3. 调用指定工具方法
4. 处理流式响应
5. 解析返回结果

```mermaid
sequenceDiagram
participant Workflow as "工作流"
participant MCPTool as "MCP工具"
participant MCPClient as "MCP客户端"
participant MCPServer as "MCP服务器"
Workflow->>MCPTool : 调用工具
MCPTool->>MCPClient : 创建客户端
MCPClient->>MCPServer : 建立连接
MCPServer-->>MCPClient : 返回连接确认
MCPClient->>MCPServer : 调用工具方法
MCPServer-->>MCPClient : 返回流式响应
MCPClient-->>MCPTool : 返回解析结果
MCPTool-->>Workflow : 返回工具结果
```

**图示来源**
- [mcp_tool.py](file://api/core/tools/mcp_tool/tool.py)

**本节来源**
- [mcp_tool.py](file://api/core/tools/mcp_tool/tool.py#L1-L108)

## 工具节点配置

工具节点是工作流中调用工具的基本单元，配置参数包括工具提供者类型、提供者ID、工具名称、参数配置和错误处理策略。

### 配置参数
- **工具提供者类型**: 内置工具、自定义工具、MCP工具等
- **提供者ID**: 工具提供者的唯一标识
- **工具名称**: 要调用的工具名称
- **参数配置**: 工具参数的值或变量引用
- **错误策略**: 失败时的处理策略（继续、终止、重试）
- **重试配置**: 重试次数和间隔

```mermaid
classDiagram
class ToolNodeData {
+provider_type : ToolProviderType
+provider_id : str
+tool_name : str
+tool_parameters : dict
+error_strategy : ErrorStrategy
+retry_config : RetryConfig
+title : str
+desc : str
}
class ToolNode {
-_node_data : ToolNodeData
+_run() : Generator
+_generate_parameters() : dict
+_transform_message() : Generator
}
class BaseNode {
+node_id : str
+tenant_id : str
+app_id : str
+user_id : str
+graph_runtime_state : GraphRuntimeState
}
ToolNode --|> BaseNode
ToolNode o-- ToolNodeData
```

**图示来源**
- [tool_node.py](file://api/core/workflow/nodes/tool/tool_node.py)

**本节来源**
- [tool_node.py](file://api/core/workflow/nodes/tool/tool_node.py#L1-L466)

## 输入输出映射

工具节点支持灵活的输入输出映射机制，允许将工作流变量作为工具参数，并将工具输出映射到工作流变量。

### 输入映射
输入映射支持三种类型：
- **变量引用**: 引用工作流中的变量值
- **常量值**: 固定的常量值
- **混合模式**: 变量和常量的组合

### 输出映射
工具执行结果包含多种输出类型：
- **文本**: 工具返回的文本内容
- **文件**: 工具生成的文件
- **JSON**: 工具返回的JSON数据
- **变量**: 工具设置的变量值

```mermaid
flowchart LR
subgraph "输入"
VariablePool[变量池]
ToolParameters[工具参数]
end
subgraph "工具执行"
ToolEngine[工具引擎]
Tool[工具]
end
subgraph "输出"
TextOutput[文本输出]
FileOutput[文件输出]
JsonOutput[JSON输出]
VariableOutput[变量输出]
end
VariablePool --> ToolParameters
ToolParameters --> ToolEngine
ToolEngine --> Tool
Tool --> ToolEngine
ToolEngine --> TextOutput
ToolEngine --> FileOutput
ToolEngine --> JsonOutput
ToolEngine --> VariableOutput
```

**图示来源**
- [tool_node.py](file://api/core/workflow/nodes/tool/tool_node.py)
- [tool_engine.py](file://api/core/tools/tool_engine.py)

**本节来源**
- [tool_node.py](file://api/core/workflow/nodes/tool/tool_node.py#L1-L466)
- [tool_engine.py](file://api/core/tools/tool_engine.py#L1-L355)

## 错误处理机制

Dify工具集成系统提供了完善的错误处理机制，包括错误分类、错误策略和错误回调。

### 错误类型
- **工具未找到**: 指定的工具不存在
- **凭证验证失败**: 工具认证信息无效
- **参数验证失败**: 工具参数不符合要求
- **工具调用失败**: 工具执行过程中发生错误
- **引擎调用失败**: 工具引擎调用失败

### 错误策略
- **继续执行**: 忽略错误，继续执行后续节点
- **终止执行**: 停止工作流执行
- **重试执行**: 按照配置重试工具调用

```mermaid
flowchart TD
Start([工具调用]) --> InvokeTool["调用工具"]
InvokeTool --> Success{"调用成功?"}
Success --> |是| ReturnSuccess["返回成功结果"]
Success --> |否| HandleError["处理错误"]
HandleError --> ErrorType{"错误类型"}
ErrorType --> |凭证错误| HandleCredential["处理凭证错误"]
ErrorType --> |参数错误| HandleParameter["处理参数错误"]
ErrorType --> |调用错误| HandleInvoke["处理调用错误"]
ErrorType --> |其他错误| HandleOther["处理其他错误"]
HandleCredential --> RetryOrFail["重试或失败"]
HandleParameter --> RetryOrFail
HandleInvoke --> RetryOrFail
HandleOther --> RetryOrFail
RetryOrFail --> ShouldRetry{"应该重试?"}
ShouldRetry --> |是| Retry["重试调用"]
ShouldRetry --> |否| ReturnError["返回错误"]
Retry --> InvokeTool
ReturnSuccess --> End([结束])
ReturnError --> End
```

**图示来源**
- [tool_engine.py](file://api/core/tools/tool_engine.py)
- [tool_node.py](file://api/core/workflow/nodes/tool/tool_node.py)

**本节来源**
- [tool_engine.py](file://api/core/tools/tool_engine.py#L1-L355)
- [tool_node.py](file://api/core/workflow/nodes/tool/tool_node.py#L1-L466)

## 凭证配置与安全沙箱

Dify平台通过加密存储和安全沙箱机制确保工具集成的安全性。

### 凭证管理
- **加密存储**: 所有凭证信息使用租户密钥加密存储
- **缓存机制**: 使用Redis缓存解密后的凭证，提高性能
- **过期处理**: 自动处理OAuth凭证的过期和刷新

### 安全沙箱
- **代码执行沙箱**: Python和JavaScript代码在隔离环境中执行
- **网络访问控制**: 限制工具的网络访问范围，防止SSRF攻击
- **资源限制**: 限制工具执行的CPU、内存和执行时间

```mermaid
graph TD
subgraph "凭证安全"
Credentials[凭证]
Encrypter[加密器]
Cache[缓存]
Database[数据库]
end
subgraph "执行安全"
CodeExecutor[代码执行器]
SSRFProxy[SSRF代理]
ResourceLimiter[资源限制器]
end
Credentials --> Encrypter
Encrypter --> Database
Database --> Encrypter
Encrypter --> Cache
Cache --> CodeExecutor
CodeExecutor --> ResourceLimiter
CodeExecutor --> SSRFProxy
style Encrypter fill:#f96,stroke:#333
style CodeExecutor fill:#69f,stroke:#333
```

**图示来源**
- [tool_manager.py](file://api/core/tools/tool_manager.py)
- [custom_tool.py](file://api/core/tools/custom_tool/tool.py)
- [simple_code.py](file://api/core/tools/builtin_tool/providers/code/tools/simple_code.py)

**本节来源**
- [tool_manager.py](file://api/core/tools/tool_manager.py#L1-L1022)
- [custom_tool.py](file://api/core/tools/custom_tool/tool.py#L1-L404)
- [simple_code.py](file://api/core/tools/builtin_tool/providers/code/tools/simple_code.py#L1-L33)

## 调用限制策略

为防止滥用和资源耗尽，Dify平台实施了多种调用限制策略。

### 限制类型
- **速率限制**: 限制单位时间内的调用次数
- **并发限制**: 限制同时执行的工具数量
- **资源限制**: 限制单次调用的资源使用
- **配额限制**: 限制每日或每月的总调用次数

### 实现机制
- **租户级限制**: 基于租户的调用配额
- **工具级限制**: 基于特定工具的调用限制
- **用户级限制**: 基于用户的调用限制

```mermaid
flowchart LR
Request[调用请求] --> CheckRateLimit["检查速率限制"]
CheckRateLimit --> RateLimitExceeded{"超出速率限制?"}
RateLimitExceeded --> |是| RejectRequest["拒绝请求"]
RateLimitExceeded --> |否| CheckConcurrency["检查并发限制"]
CheckConcurrency --> ConcurrencyExceeded{"超出并发限制?"}
ConcurrencyExceeded --> |是| RejectRequest
ConcurrencyExceeded --> |否| CheckResource["检查资源限制"]
CheckResource --> ResourceExceeded{"超出资源限制?"}
ResourceExceeded --> |是| RejectRequest
ResourceExceeded --> |否| ExecuteTool["执行工具"]
ExecuteTool --> UpdateMetrics["更新指标"]
UpdateMetrics --> ReturnResult["返回结果"]
RejectRequest --> ReturnError["返回错误"]
```

**图示来源**
- [tool_engine.py](file://api/core/tools/tool_engine.py)
- [tool_manager.py](file://api/core/tools/tool_manager.py)

**本节来源**
- [tool_engine.py](file://api/core/tools/tool_engine.py#L1-L355)
- [tool_manager.py](file://api/core/tools/tool_manager.py#L1-L1022)

## 常见问题排查

### 凭证错误
**症状**: 工具调用返回"凭证验证失败"错误
**解决方案**:
1. 检查凭证是否正确配置
2. 对于OAuth工具，重新进行授权
3. 检查凭证是否已过期

### 超时设置
**症状**: 工具调用超时
**解决方案**:
1. 检查目标服务是否响应缓慢
2. 调整API工具的超时设置
3. 优化工具执行逻辑

### 网络访问限制
**症状**: 工具调用无法访问外部服务
**解决方案**:
1. 检查网络连接是否正常
2. 确认目标服务地址是否可达
3. 检查防火墙或代理设置

### 代码执行错误
**症状**: 代码工具执行失败
**解决方案**:
1. 检查代码语法是否正确
2. 确认使用的语言是否支持
3. 检查代码是否超出资源限制

**本节来源**
- [tool_engine.py](file://api/core/tools/tool_engine.py#L1-L355)
- [tool_node.py](file://api/core/workflow/nodes/tool/tool_node.py#L1-L466)
- [custom_tool.py](file://api/core/tools/custom_tool/tool.py#L1-L404)
- [mcp_tool.py](file://api/core/tools/mcp_tool/tool.py#L1-L108)