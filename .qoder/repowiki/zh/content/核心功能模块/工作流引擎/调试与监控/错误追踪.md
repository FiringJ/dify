# 错误追踪

<cite>
**本文档引用文件**  
- [errors.py](file://api/core/workflow/errors.py)
- [base/exc.py](file://api/core/workflow/nodes/base/exc.py)
- [llm/exc.py](file://api/core/workflow/nodes/llm/exc.py)
- [code/exc.py](file://api/core/workflow/nodes/code/exc.py)
- [http_request/exc.py](file://api/core/workflow/nodes/http_request/exc.py)
- [document_extractor/exc.py](file://api/core/workflow/nodes/document_extractor/exc.py)
- [knowledge_retrieval/exc.py](file://api/core/workflow/nodes/knowledge_retrieval/exc.py)
- [workflow_entry.py](file://api/core/workflow/workflow_entry.py)
- [workflow_logging_callback.py](file://api/core/workflow/callbacks/workflow_logging_callback.py)
- [workflow_execution_repository.py](file://api/core/workflow/repositories/workflow_execution_repository.py)
- [workflow_node_execution_repository.py](file://api/core/workflow/repositories/workflow_node_execution_repository.py)
</cite>

## 目录
1. [引言](#引言)
2. [工作流错误分类](#工作流错误分类)
3. [错误信息记录与展示格式](#错误信息记录与展示格式)
4. [错误定位流程](#错误定位流程)
5. [常见错误解决方案库](#常见错误解决方案库)
6. [错误告警机制](#错误告警机制)
7. [错误处理最佳实践](#错误处理最佳实践)
8. [结论](#结论)

## 引言
Dify 工作流系统在执行过程中可能遇到多种类型的错误，包括节点执行失败、超时、数据类型不匹配、API 调用异常等。本文档旨在详细说明 Dify 工作流的错误追踪功能，涵盖错误分类、日志记录、定位方法、解决方案及告警机制，帮助开发者和运维人员快速识别并解决执行过程中的问题。

**Section sources**
- [errors.py](file://api/core/workflow/errors.py)
- [workflow_entry.py](file://api/core/workflow/workflow_entry.py)

## 工作流错误分类
Dify 工作流中的错误按节点类型和异常来源进行系统分类，主要分为以下几类：

### 节点执行失败
当某个节点在执行过程中发生异常时，抛出 `WorkflowNodeRunFailedError`，包含节点标题和具体错误信息，用于标识执行失败的节点。

### LLM 节点错误
LLM 节点可能出现以下异常：
- `VariableNotFoundError`：变量未找到
- `InvalidContextStructureError`：上下文结构无效
- `ModelNotExistError`：模型不存在
- `NoPromptFoundError`：未找到提示词
- `FileTypeNotSupportError`：文件类型不支持
- `UnsupportedPromptContentTypeError`：提示内容类型不支持

### 代码节点错误
代码节点执行中可能触发：
- `OutputValidationError`：输出验证失败
- `DepthLimitError`：递归深度超限

### HTTP 请求节点错误
HTTP 节点常见错误包括：
- `AuthorizationConfigError`：授权配置错误
- `InvalidURLError`：URL 无效
- `InvalidHttpMethodError`：HTTP 方法不合法
- `ResponseSizeError`：响应体过大
- `RequestBodyError`：请求体格式错误

### 文档提取节点错误
文档提取过程中可能出现：
- `FileDownloadError`：文件下载失败
- `UnsupportedFileTypeError`：不支持的文件类型
- `TextExtractionError`：文本提取失败

### 知识检索节点错误
知识检索节点相关异常：
- `ModelNotExistError`：模型不存在
- `ModelCredentialsNotInitializedError`：模型凭证未初始化
- `ModelQuotaExceededError`：模型配额超限
- `InvalidModelTypeError`：模型类型不合法

### 基础节点通用错误
所有节点继承的基础错误类型：
- `BaseNodeError`：节点基类错误
- `DefaultValueTypeError`：默认值类型错误

**Section sources**
- [errors.py](file://api/core/workflow/errors.py)
- [base/exc.py](file://api/core/workflow/nodes/base/exc.py)
- [llm/exc.py](file://api/core/workflow/nodes/llm/exc.py)
- [code/exc.py](file://api/core/workflow/nodes/code/exc.py)
- [http_request/exc.py](file://api/core/workflow/nodes/http_request/exc.py)
- [document_extractor/exc.py](file://api/core/workflow/nodes/document_extractor/exc.py)
- [knowledge_retrieval/exc.py](file://api/core/workflow/nodes/knowledge_retrieval/exc.py)

## 错误信息记录与展示格式
Dify 工作流通过结构化方式记录和展示错误信息，确保可读性和可追溯性。

### 错误信息结构
每个错误记录包含以下字段：
- **错误码**：唯一标识错误类型的编码（如 `LLM_MODEL_NOT_EXIST`）
- **错误消息**：人类可读的描述信息
- **节点名称**：发生错误的节点标题
- **堆栈跟踪**：Python 异常堆栈，用于定位代码层级
- **时间戳**：错误发生时间
- **执行ID**：关联的工作流执行实例ID

### 日志输出格式
错误日志采用 JSON 格式输出，便于系统采集和分析：
```json
{
  "level": "ERROR",
  "timestamp": "2025-04-05T10:00:00Z",
  "workflow_execution_id": "exec-abc123",
  "node_id": "llm-node-1",
  "node_type": "llm",
  "error_code": "MODEL_NOT_EXIST",
  "message": "指定的模型 gpt-5 不存在",
  "stack_trace": "..."
}
```

**Section sources**
- [workflow_logging_callback.py](file://api/core/workflow/callbacks/workflow_logging_callback.py)
- [workflow_execution_repository.py](file://api/core/workflow/repositories/workflow_execution_repository.py)
- [workflow_node_execution_repository.py](file://api/core/workflow/repositories/workflow_node_execution_repository.py)

## 错误定位流程
Dify 提供完整的错误定位流程，帮助开发者快速找到问题源头。

### 执行日志追踪
通过 `workflow_logging_callback` 捕获每个节点的执行状态变化，记录开始、成功、失败事件，并关联唯一 `trace_id`。

### 节点执行上下文保存
每次节点执行的输入、输出、参数和异常信息均持久化至数据库，可通过 `workflow_node_execution_repository` 查询。

### 链路追踪集成
支持与 Sentry、OpenTelemetry 等观测性工具集成，提供分布式链路追踪能力，跨服务定位调用异常。

### 调试工具支持
前端工作流编辑器提供“调试模式”，可逐节点查看执行结果与错误详情，支持断点式执行与变量快照。

**Section sources**
- [workflow_logging_callback.py](file://api/core/workflow/callbacks/workflow_logging_callback.py)
- [workflow_node_execution_repository.py](file://api/core/workflow/repositories/workflow_node_execution_repository.py)
- [workflow_entry.py](file://api/core/workflow/workflow_entry.py)

## 常见错误解决方案库
### 处理 LLM 返回格式错误
**问题**：LLM 输出不符合预期 JSON 格式  
**解决方案**：
1. 在提示词中明确要求 JSON 输出格式
2. 添加“重试”机制，对解析失败的响应自动重试
3. 使用 `output_parser` 模块进行容错解析
4. 设置默认值兜底策略

### 修复数据转换异常
**问题**：变量类型不匹配导致转换失败  
**解决方案**：
1. 在变量赋值前使用 `variable_loader` 进行类型校验
2. 定义清晰的变量 schema，使用 `VariablePool` 统一管理
3. 添加类型转换中间节点（如字符串转数字）
4. 抛出 `InvalidVariableTypeError` 并提示用户检查输入

### 处理 API 调用超时
**问题**：HTTP 节点请求超时  
**解决方案**：
1. 配置合理的超时时间（默认 30s）
2. 启用重试策略（最多 3 次）
3. 使用断路器模式防止雪崩
4. 记录失败请求体用于重放调试

### 文件提取失败
**问题**：文档提取节点无法读取文件内容  
**解决方案**：
1. 检查文件是否成功上传并可达
2. 验证文件 MIME 类型是否支持
3. 使用 `tool_file_parser` 预检测文件可读性
4. 提供备用提取路径或人工审核入口

**Section sources**
- [llm/exc.py](file://api/core/workflow/nodes/llm/exc.py)
- [http_request/exc.py](file://api/core/workflow/nodes/http_request/exc.py)
- [document_extractor/exc.py](file://api/core/workflow/nodes/document_extractor/exc.py)
- [variable_loader.py](file://api/core/workflow/variable_loader.py)
- [nodes/tool](file://api/core/workflow/nodes/tool)

## 错误告警机制
Dify 支持多种错误告警方式，确保关键异常能及时通知相关人员。

### 邮件通知配置
通过 `inner_api/mail.py` 发送告警邮件，需在系统配置中设置 SMTP 服务器信息，并启用“执行失败告警”开关。

### Webhook 回调
支持自定义 Webhook 地址，当工作流执行失败时，向指定 URL 发送 POST 请求，包含错误详情：
```json
{
  "event": "workflow.failed",
  "execution_id": "exec-abc123",
  "node_id": "llm-1",
  "error": {
    "code": "MODEL_NOT_EXIST",
    "message": "模型不存在"
  }
}
```

### 集成第三方监控
通过 `configs/observability/otel` 配置 OpenTelemetry 上报，支持接入 Prometheus、Grafana、Sentry 等系统。

**Section sources**
- [inner_api/mail.py](file://api/controllers/inner_api/mail.py)
- [configs/observability/otel](file://api/configs/observability/otel)
- [workflow_logging_callback.py](file://api/core/workflow/callbacks/workflow_logging_callback.py)

## 错误处理最佳实践
### 合理设置重试策略
- 对于网络类错误（如超时、5xx），建议设置指数退避重试（最多 3 次）
- 对于永久性错误（如模型不存在、参数错误），不应重试
- 使用 `Celery` 任务队列支持异步重试机制

### 添加异常处理节点
在关键路径后插入“条件判断”节点，捕获前序节点的错误输出，执行补偿逻辑或降级方案。

### 使用调试模式开发
在工作流开发阶段启用调试模式，实时查看变量流动和节点输出，避免上线后才发现问题。

### 定期清理执行日志
通过 `schedule/clean_workflow_runlogs_precise.py` 定期归档旧日志，避免数据库膨胀影响性能。

### 监控关键指标
- 节点失败率
- 平均执行时间
- LLM 调用成功率
- API 错误码分布

**Section sources**
- [workflow_node_execution_tasks.py](file://api/tasks/workflow_node_execution_tasks.py)
- [workflow_execution_tasks.py](file://api/tasks/workflow_execution_tasks.py)
- [schedule/clean_workflow_runlogs_precise.py](file://api/schedule/clean_workflow_runlogs_precise.py)

## 结论
Dify 工作流系统提供了完善的错误追踪机制，涵盖从异常分类、日志记录、定位分析到告警响应的全生命周期管理。通过结构化的错误体系和丰富的调试工具，开发者能够高效排查和解决执行问题。建议在实际使用中结合重试策略、异常处理节点和监控告警，构建高可用的工作流应用。