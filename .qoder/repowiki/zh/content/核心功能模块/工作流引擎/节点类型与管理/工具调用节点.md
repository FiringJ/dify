# 工具调用节点

<cite>
**本文档中引用的文件**  
- [tool_manager.py](file://api/core/tools/tool_manager.py)
- [tool_engine.py](file://api/core/tools/tool_engine.py)
- [builtin_tool/tool.py](file://api/core/tools/builtin_tool/tool.py)
- [custom_tool/tool.py](file://api/core/tools/custom_tool/tool.py)
- [mcp_tool/tool.py](file://api/core/tools/mcp_tool/tool.py)
- [tool.py](file://api/core/tools/__base/tool.py)
- [tool_runtime.py](file://api/core/tools/__base/tool_runtime.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排查指南](#故障排查指南)
9. [结论](#结论)

## 简介
本文档详细介绍了Dify工作流引擎中的工具调用节点，涵盖内置工具、自定义工具和MCP工具的集成机制，以及工具发现与权限管理。文档还提供了工具节点的配置方法、执行流程、实现细节、使用示例、故障排查和性能优化建议。

## 项目结构
Dify的工具调用功能主要位于`api/core/tools`目录下，该目录包含多个子模块，分别处理不同类型的工具。

```mermaid
graph TD
A[api/core/tools] --> B[__base]
A --> C[builtin_tool]
A --> D[custom_tool]
A --> E[mcp_tool]
A --> F[plugin_tool]
A --> G[workflow_as_tool]
A --> H[utils]
A --> I[tool_manager.py]
A --> J[tool_engine.py]
B --> K[tool.py]
B --> L[tool_runtime.py]
C --> M[provider.py]
C --> N[tool.py]
D --> O[provider.py]
D --> P[tool.py]
E --> Q[provider.py]
E --> R[tool.py]
```

**图示来源**  
- [tool_manager.py](file://api/core/tools/tool_manager.py)
- [tool_engine.py](file://api/core/tools/tool_engine.py)

**本节来源**  
- [tool_manager.py](file://api/core/tools/tool_manager.py)
- [tool_engine.py](file://api/core/tools/tool_engine.py)

## 核心组件
工具调用节点的核心组件包括工具管理器（ToolManager）、工具引擎（ToolEngine）和各种工具实现类。这些组件共同协作，实现工具的注册、调用和结果处理。

**本节来源**  
- [tool_manager.py](file://api/core/tools/tool_manager.py)
- [tool_engine.py](file://api/core/tools/tool_engine.py)

## 架构概述
Dify的工具调用架构采用分层设计，从上到下分为工具管理、工具执行和工具实现三个层次。工具管理负责工具的发现和权限验证，工具执行负责调用流程的控制，工具实现则具体处理不同类型的工具调用。

```mermaid
graph TD
A[工具调用节点] --> B[工具管理器]
A --> C[工具引擎]
B --> D[内置工具]
B --> E[自定义工具]
B --> F[MCP工具]
C --> G[代理调用]
C --> H[通用调用]
D --> I[BuiltinTool]
E --> J[ApiTool]
F --> K[MCPTool]
G --> L[AgentInvoke]
H --> M[GenericInvoke]
```

**图示来源**  
- [tool_manager.py](file://api/core/tools/tool_manager.py)
- [tool_engine.py](file://api/core/tools/tool_engine.py)

## 详细组件分析

### 工具管理器分析
工具管理器（ToolManager）是工具调用的核心组件，负责管理所有类型的工具提供者和工具实例。

#### 类图
```mermaid
classDiagram
class ToolManager {
+get_tool_runtime(provider_type, provider_id, tool_name, tenant_id) Tool
+get_agent_tool_runtime(tenant_id, app_id, agent_tool) Tool
+get_workflow_tool_runtime(tenant_id, app_id, node_id, workflow_tool) Tool
+list_providers_from_api(user_id, tenant_id, typ) list[ToolProviderApiEntity]
+get_api_provider_controller(tenant_id, provider_id) tuple[ApiToolProviderController, dict]
+get_mcp_provider_controller(tenant_id, provider_id) MCPToolProviderController
}
class Tool {
+entity ToolEntity
+runtime ToolRuntime
+invoke(user_id, tool_parameters) Generator[ToolInvokeMessage]
+fork_tool_runtime(runtime) Tool
+tool_provider_type() ToolProviderType
}
class BuiltinTool {
+provider str
+invoke_model(user_id, prompt_messages, stop) LLMResult
+summary(user_id, content) str
}
class ApiTool {
+api_bundle ApiToolBundle
+provider_id str
+validate_credentials(credentials, parameters) str
+assembling_request(parameters) dict
+do_http_request(url, method, headers, parameters) httpx.Response
}
class MCPTool {
+tenant_id str
+icon str
+server_url str
+provider_id str
+headers dict
+timeout float
+sse_read_timeout float
}
ToolManager --> Tool : "管理"
Tool <|-- BuiltinTool : "继承"
Tool <|-- ApiTool : "继承"
Tool <|-- MCPTool : "继承"
```

**图示来源**  
- [tool_manager.py](file://api/core/tools/tool_manager.py)
- [builtin_tool/tool.py](file://api/core/tools/builtin_tool/tool.py)
- [custom_tool/tool.py](file://api/core/tools/custom_tool/tool.py)
- [mcp_tool/tool.py](file://api/core/tools/mcp_tool/tool.py)

**本节来源**  
- [tool_manager.py](file://api/core/tools/tool_manager.py)

### 工具引擎分析
工具引擎（ToolEngine）负责执行工具调用，处理调用过程中的回调、错误和结果转换。

#### 序列图
```mermaid
sequenceDiagram
participant 调用方
participant 工具引擎
participant 工具
participant 回调处理器
调用方->>工具引擎 : agent_invoke(tool, parameters)
工具引擎->>回调处理器 : on_tool_start()
工具引擎->>工具 : _invoke(parameters)
工具-->>工具引擎 : 返回结果
工具引擎->>工具引擎 : 处理二进制数据
工具引擎->>工具引擎 : 创建消息文件
工具引擎->>工具引擎 : 转换为文本
工具引擎->>回调处理器 : on_tool_end()
工具引擎-->>调用方 : 返回文本结果和文件ID
```

**图示来源**  
- [tool_engine.py](file://api/core/tools/tool_engine.py)

**本节来源**  
- [tool_engine.py](file://api/core/tools/tool_engine.py)

### 工具实现分析
Dify支持多种类型的工具实现，包括内置工具、自定义工具和MCP工具，每种工具都有其特定的实现方式。

#### 流程图
```mermaid
flowchart TD
A[开始] --> B{工具类型}
B --> |内置工具| C[调用模型或内置逻辑]
B --> |自定义工具| D[构建HTTP请求]
D --> E[发送HTTP请求]
E --> F[解析响应]
B --> |MCP工具| G[建立MCP连接]
G --> H[调用MCP工具]
H --> I[处理结果]
C --> J[返回结果]
F --> J
I --> J
J --> K[结束]
```

**图示来源**  
- [builtin_tool/tool.py](file://api/core/tools/builtin_tool/tool.py)
- [custom_tool/tool.py](file://api/core/tools/custom_tool/tool.py)
- [mcp_tool/tool.py](file://api/core/tools/mcp_tool/tool.py)

**本节来源**  
- [builtin_tool/tool.py](file://api/core/tools/builtin_tool/tool.py)
- [custom_tool/tool.py](file://api/core/tools/custom_tool/tool.py)
- [mcp_tool/tool.py](file://api/core/tools/mcp_tool/tool.py)

## 依赖分析
工具调用节点依赖于多个核心模块，包括模型运行时、回调处理器、文件管理器和数据库。

```mermaid
graph TD
A[工具调用节点] --> B[模型运行时]
A --> C[回调处理器]
A --> D[文件管理器]
A --> E[数据库]
A --> F[SSRF代理]
B --> G[LLM调用]
C --> H[调用跟踪]
D --> I[文件下载]
E --> J[凭证存储]
F --> K[安全请求]
```

**图示来源**  
- [tool_manager.py](file://api/core/tools/tool_manager.py)
- [tool_engine.py](file://api/core/tools/tool_engine.py)

**本节来源**  
- [tool_manager.py](file://api/core/tools/tool_manager.py)
- [tool_engine.py](file://api/core/tools/tool_engine.py)

## 性能考虑
工具调用节点的性能主要受网络请求、模型调用和数据处理的影响。建议优化HTTP请求超时设置、合理使用缓存和限制并发调用数量。

## 故障排查指南
常见问题包括凭证验证失败、网络连接超时和参数验证错误。建议检查凭证配置、网络连接和参数格式。

**本节来源**  
- [tool_engine.py](file://api/core/tools/tool_engine.py)
- [custom_tool/tool.py](file://api/core/tools/custom_tool/tool.py)

## 结论
Dify的工具调用节点提供了灵活且强大的工具集成能力，支持多种工具类型和复杂的调用场景。通过合理的配置和优化，可以实现高效稳定的工具调用。